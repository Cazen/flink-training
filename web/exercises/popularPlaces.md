---
layout: page
title: DataStream API - Popular Places
permalink: /exercises/popularPlaces.html
---

The task of the "Popular Places" exercise is to identify popular places and events from the taxi ride data set. This shall be done by counting every five minutes the number of taxi rides that started and ended within the same area within the last 15 minutes. Arrival and departure locations should be separately counted. Only locations with more arrivals or departures than a provided threshold `popThreshold` should be forwarded to the stream.

The `GeoUtils` class provides a static method `GeoUtils.mapToGridCell(float lon, float lat)` which maps a location (longitude, latitude) to a cell id that refers to an area of approximately 100x100 meters size. The `GeoUtils` class also provides reverse methods to compute the longitude and latitude of a cell id. 

### Input Data

The input data of this exercise is a stream of `TaxiRide` records generated by the [Taxi Stream generator]({{ site.baseurl }}/exercises/taxiData.html) filtered by the New York City area filter of the [Taxi Ride Cleansing exercise]({{ site.baseurl }}/exercises/rideCleansing.html) (reuse the FilterFunction of the Taxi Ride Cleansing exercise).

### Expected Output

The result of this exercise is a `DataStream<Tuple4<Float, Float, Boolean, Integer>>`. Each record refers a cell area (the `Float` fields are longitude and latitude of the area center), with at least `popThreshold` taxi rides arriving or departing (indicated by the `Boolean` field) within the last 15 minutes. The `Integer` field of a record specifies the arrivial or departure count.

The result stream can be written to standard out, Kafka, or to a file.

### Implementation Hints

#### Program Structure

The task requires to count taxi ride records by cell id and event type (start or end record). Hence, we need to obtain a cell id for each record and group the records by cell id and record type. Subsequently, we need to count every five minutes how many records arrived in each group within the last 15 minutes. The windows are built using a time-based sliding window and the count can done using a `WindowMapFunction`. Finally, the windowed stream needs to be flattened and written to a stream sink.

#### Mapping a Taxi Ride record to its Cell Id

Each `TaxiRide` record must be mapped to a cell id. This can be done by a `MapFunction` which calls the `GeoUtils.mapToGridCell()` method. Start records are mapped to the start location, end records are mapped to the end location.

#### Grouping by Cell Id and Event Type

In order to compute separate area counts for arriving and departing taxi rides, the records needs to be grouped by area and event type. You can group a data stream a composite key by handing a list of keys to `DataStream.groupBy()`.

#### Computing the Sliding Count

Use a `WindowedDataStream.window().every()` to define a sliding window that triggers every five minutes a count of the records of the last 15 minutes. The counting can be implemented as a `WindowMapFunction` which also checks whether the computed count exceeds the specified popularity threshold.

Please be aware that the window times need to be adjusted by the speed factor of the [Taxi Data Generator]({{ site.baseurl }}/exercises/taxiData.html) as well.

### Reference Solution

Reference solutions are available at GitHub:

- Java: [PopularPlaces.java](https://github.com/dataArtisans/flink-training/blob/master/flink-exercises/src/main/java/com/dataArtisans/flinkTraining/exercises/dataStreamJava/popularPlaces/PopularPlaces.java)
